@page "/employee/{Id:int}"
@using HCM.Client.Components
@using HCM.Client.Components.Modals
@inject HttpClient httpClient
@inject NavigationManager navigationManager
@inject ModalService ModalService

<RolePropertiesModal />

<form class="needs-validation">

    @if (employee != null)
    {
        <div class="hovereffect">
            @if (employee.Image == null)
            {
                <div class="img-thumbnail" style="width: 100px;" />
            }
            else
            {
                <img src="/Images/@employee.Image" alt="@employee.Name" class="img-thumbnail img-responsive" />
            }
            <a class="info" href="#">Change Image</a>
        </div>

        <div class="form-row">
            <div class="col">
                <label for="txtName">Name:</label>
                <input id="txtName" type="text" class="form-control" placeholder="Enter employee's name" @bind="employee.Name" required autofocus />
                <div class="invalid-feedback">
                    You must enter a name.
                </div>
            </div>
            <div class="col">
                <label for="txtPhone">Phone:</label>
                <input id="txtPhone" type="tel" class="form-control" placeholder="Enter employee's phone" @bind="employee.Phone" />
                <div class="invalid-feedback">
                    You must enter a valid phone.
                </div>
            </div>
        </div>
        <div class="form-row">
            <div class="col">
                <label for="txtEmail">Email:</label>
                <input id="txtEmail" type="email" class="form-control" placeholder="Enter employee's email" @bind="employee.Email" />
                <div class="invalid-feedback">
                    You must enter a valid email.
                </div>
            </div>
            <div class="col">
                <label for="dtpDateOfBirth">Date of Birth:</label>
                <input id="dtpDateOfBirth" type="date" class="form-control" placeholder="Enter employee's email" @bind="employee.DateOfBirth" />
            </div>
        </div>
        <div class="form-row">
            <div class="col">
                Gender:
                <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" id="rbMale" name="rbGender" class="custom-control-input" checked='@(employee.Gender == "M")' @onchange='(() => employee.Gender = "M")' />
                    <label for="rbMale" class="custom-control-label">Male</label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" id="rbFemale" name="rbGender" class="custom-control-input" checked='@(employee.Gender == "F")' @onchange='(() => employee.Gender = "F")' />
                    <label for="rbFemale" class="custom-control-label">Female</label>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>Employee's Interest/Expertise Skills:</label>
            <MultiSelect TItem="GqlSkill" Placeholder="Type to Search" Items="Skills" Values="employee.Skills" DisplayFieldSelector="@(i => i.Name)" OnValueRemoved="@SkillRemoved" OnAddNewItem="@AddNewSkill" />
        </div>
            <button class="btn btn-primary underline-first-letter" type="submit" accesskey="s" @onclick="Save">Save</button>
            <button class="btn btn-secondary underline-first-letter" accesskey="c" @onclick="Cancel">Cancel</button>
    }
</form>

@code
{
    [Parameter]
    public int Id { get; set; }

    private GraphQLApiClient gql = null;
    private GqlEmployee employee = null;

    private List<GqlSkill> Skills;
    private List<GqlSkill> RemovedSkills;

    protected override async Task OnInitializedAsync()
    {
        gql = new GraphQLApiClient(httpClient, "http://localhost:7474/graphql/");

        if (Id > 0)
        {
            var query = gql.Employee(string.Empty, _id: Id, fields: e => new GqlEmployee
            {
                _id = e._id,
                Name = e.Name,
                Gender = e.Gender,
                Phone = e.Phone,
                Email = e.Email,
                Image = e.Image,
                DateOfBirth = e.DateOfBirth,
                Skills = new List<GqlSkill>
{
                    new GqlSkill
                    {
                        Name = e.Skills[0].Name
                    }
                }
            });

            employee = (await query.RunAsync()).FirstOrDefault();
            //employee.Skills = new List<GqlSkill>();
        }
        else
            employee = new GqlEmployee();

        //Load Roles
        Skills = await gql.Skill(string.Empty, fields: r => new GqlSkill
        {
            _id = r._id,
            Name = r.Name
        }).RunAsync();

        RemovedSkills = new List<GqlSkill>();
    }

    public void ChangeImage()
    {
    }

    public void Save()
    {
        // Save Employee
        gql.MergeEmployee(string.Empty, employee.Name, employee.DateOfBirth, employee.Email, employee.Gender, phone: employee.Phone).RunAsync();

        SaveSkills();

        Cancel();
    }

    private void SaveSkills()
    {
        // Insert newly created skills, if any
        foreach (var skill in Skills.Where(s => !s._id.HasValue))
            gql.CreateSkill(string.Empty, skill.Name).RunAsync();

        // Save employee skills
        gql.AddEmployeeSkills(string.Empty, employee.Name, employee.Skills.Select(s => s.Name).ToArray()).RunAsync();

        // Delete removed skills, if any
        var skillsToRemove = RemovedSkills.Select(s => s.Name).Except(employee.Skills.Select(es => es.Name));

        if (skillsToRemove.Any())
            gql.DeleteEmployeeSkills(string.Empty, employee.Name, skillsToRemove.ToArray()).RunAsync();
    }

    public void Cancel()
    {
        navigationManager.NavigateTo("/employees");
    }

    public void AddNewSkill(string text)
    {
        var newSkill = new GqlSkill { Name = text };
        Skills.Add(newSkill);
        employee.Skills.Add(newSkill);
    }

    public void SkillRemoved(GqlSkill skill)
    {
        RemovedSkills.Add(skill);
        employee.Skills.Remove(skill);
    }
}
